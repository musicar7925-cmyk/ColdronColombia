<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Coldron Colombia</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- html2pdf (Descargar PDF directo) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    /* Imprimir: solo el resumen (#printArea) */
    @media print {
      .no-print { display: none !important; }
      #printArea { display: block !important; }
      body { background: #fff !important; }
      .avoid-break { break-inside: avoid; page-break-inside: avoid; }
      .page-break { break-before: page; page-break-before: always; }
      @page { size: A4; margin: 12mm; }
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <!-- HEADER -->
  <header class="no-print sticky top-0 z-20 border-b border-slate-200 bg-white/90 backdrop-blur">
    <div class="mx-auto max-w-6xl px-4 py-4">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="flex items-center gap-3">
          <!-- Logo Coldron (URL) -->
          <img
            src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ-jAnp9C1mhpW1RVtR_MGWwnQLJGGf9Qg0Uw&s"
            alt="Coldron Colombia"
            class="h-10 w-auto"
            referrerpolicy="no-referrer"
            crossorigin="anonymous"
            onerror="this.style.display='none'"
          />
          <div>
            <h1 class="text-xl font-bold tracking-tight">Coldron Colombia</h1>
            <p class="text-sm text-slate-600">Formulario profesional para recopilar la información y generar un PDF resumen.</p>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <span id="statusBadge" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600">
            Borrador local: <span class="font-semibold text-slate-900" id="saveStatus">listo</span>
          </span>
          <button type="button" class="no-print rounded-xl bg-slate-100 px-3 py-2 text-sm font-semibold hover:bg-slate-200"
                  onclick="resetDraft()">
            Reiniciar
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-6">
    <!-- ALERT -->
    <div id="alertBox" class="no-print mb-5 hidden rounded-2xl border border-rose-200 bg-rose-50 p-4">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="font-semibold text-rose-900">Faltan datos obligatorios</div>
          <p class="mt-1 text-sm text-rose-800">Completa lo siguiente para generar el resumen.</p>
        </div>
        <button type="button" class="rounded-xl bg-white px-3 py-1.5 text-sm font-semibold text-rose-900 ring-1 ring-rose-200 hover:bg-rose-100"
                onclick="hideAlert()">Cerrar</button>
      </div>
      <ul id="missingList" class="mt-3 list-disc space-y-1 pl-5 text-sm text-rose-900"></ul>
    </div>

    <!-- FORM VIEW -->
    <section id="formView" class="no-print grid gap-6">
      <!-- Card: Datos del CDA -->
      <section class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
        <div class="flex flex-col gap-1">
          <h2 class="text-lg font-bold">1) Datos del CDA</h2>
          <p class="text-sm text-slate-600">Información base para ficha, ubicación, confianza y CTA.</p>
        </div>

        <div class="mt-6 grid gap-4 sm:grid-cols-2">
          <div>
            <label class="text-sm font-semibold">Nombre del CDA (comercial) <span class="text-rose-600">*</span></label>
            <input id="cdaName" data-required="true" data-label="Nombre del CDA"
              class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="Ej: CDA La 13" />
          </div>
          <div>
            <label class="text-sm font-semibold">Razón social <span class="text-rose-600">*</span></label>
            <input id="legalName" data-required="true" data-label="Razón social"
              class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="Ej: CDA LA 13 S.A.S." />
          </div>

          <div>
            <label class="text-sm font-semibold">NIT <span class="text-rose-600">*</span></label>
            <input id="nit" data-required="true" data-label="NIT"
              class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="Ej: 900123456-7" />
          </div>
          <div>
            <label class="text-sm font-semibold">WhatsApp oficial <span class="text-rose-600">*</span></label>
            <input id="whatsapp" data-required="true" data-label="WhatsApp oficial"
              class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="Ej: +57 300 123 4567" />
          </div>

          <div class="sm:col-span-2">
            <label class="text-sm font-semibold">Dirección + Localidad + Barrio <span class="text-rose-600">*</span></label>
            <input id="address" data-required="true" data-label="Dirección/Localidad/Barrio"
              class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm"
              placeholder="Ej: Cra XX #XX-XX, Puente Aranda, Barrio X" />
          </div>

          <div>
            <label class="text-sm font-semibold">Link Google Maps (recomendado)</label>
            <input id="maps" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm"
              placeholder="https://maps.app.goo.gl/..." />
          </div>
          <div>
            <label class="text-sm font-semibold">Horarios <span class="text-rose-600">*</span></label>
            <input id="hours" data-required="true" data-label="Horarios"
              class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm"
              placeholder="Ej: Lun–Sáb 7:00–17:00" />
          </div>
        </div>
      </section>

      <!-- Card: Operación y ventas -->
      <section class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
        <h2 class="text-lg font-bold">2) Operación, servicios y ventas</h2>
        <p class="mt-1 text-sm text-slate-600">Lo que vendemos, cómo atendemos y qué hace diferente al CDA.</p>

        <div class="mt-6 grid gap-6">
          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-5">
            <div class="text-sm font-semibold">Tipo de línea <span class="text-rose-600">*</span></div>
            <div class="mt-3 grid gap-2 sm:grid-cols-4 text-sm">
              <label class="flex items-center gap-2"><input id="lineMotos" type="checkbox" class="h-4 w-4 rounded border-slate-300"> Motos</label>
              <label class="flex items-center gap-2"><input id="lineLivianos" type="checkbox" class="h-4 w-4 rounded border-slate-300"> Livianos</label>
              <label class="flex items-center gap-2"><input id="linePesados" type="checkbox" class="h-4 w-4 rounded border-slate-300"> Pesados</label>
              <label class="flex items-center gap-2"><input id="lineMixto" type="checkbox" class="h-4 w-4 rounded border-slate-300"> Mixto</label>
            </div>
            <div class="mt-2 text-xs text-slate-600">Debes seleccionar al menos una opción.</div>
          </div>

          <div class="grid gap-4 sm:grid-cols-2">
            <div class="rounded-2xl border border-slate-200 p-5">
              <div class="text-sm font-semibold">Modalidad de atención <span class="text-rose-600">*</span></div>
              <div class="mt-3 flex flex-wrap gap-3 text-sm">
                <label class="flex items-center gap-2"><input type="radio" name="mode" value="Orden de llegada" class="h-4 w-4"> Orden de llegada</label>
                <label class="flex items-center gap-2"><input type="radio" name="mode" value="Con agenda" class="h-4 w-4"> Con agenda</label>
              </div>
              <div class="mt-4">
                <label class="text-sm font-semibold">Tiempo promedio del proceso <span class="text-rose-600">*</span></label>
                <input id="avgTime" data-required="true" data-label="Tiempo promedio del proceso"
                  class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="Ej: 45–60 min" />
              </div>
              <div class="mt-4">
                <label class="text-sm font-semibold">Link wa.me (si agenda)</label>
                <input id="waLink" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="https://wa.me/57..." />
              </div>
            </div>

            <div class="rounded-2xl border border-slate-200 p-5">
              <div class="text-sm font-semibold">Diferenciales (mínimo 3) <span class="text-rose-600">*</span></div>
              <p class="mt-1 text-sm text-slate-600">Lo que los hace elegirlos a ustedes.</p>
              <div id="diffWrap" class="mt-4 grid gap-2"></div>
              <button type="button" class="mt-3 rounded-xl bg-slate-900 px-3 py-2 text-sm font-semibold text-white hover:bg-black"
                      onclick="addRow('diffWrap','diff')">
                Agregar diferencial
              </button>
            </div>
          </div>

          <div class="rounded-2xl border border-slate-200 p-5">
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
              <div>
                <div class="text-sm font-semibold">Servicios ofrecidos <span class="text-rose-600">*</span></div>
                <p class="text-sm text-slate-600">Ej: RTM, Gases, Pre-revisión, etc. (mínimo 1).</p>
              </div>
              <button type="button" class="rounded-xl bg-slate-100 px-3 py-2 text-sm font-semibold hover:bg-slate-200"
                      onclick="addRow('servicesWrap','service')">
                Agregar servicio
              </button>
            </div>
            <div id="servicesWrap" class="mt-4 grid gap-2"></div>
          </div>

          <div class="rounded-2xl border border-slate-200 p-5">
            <div class="text-sm font-semibold">Precios (si aplican)</div>
            <div class="mt-4 grid gap-3 sm:grid-cols-3">
              <div>
                <label class="text-sm font-semibold">Moto</label>
                <input id="priceMoto" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="$" />
              </div>
              <div>
                <label class="text-sm font-semibold">Liviano</label>
                <input id="priceLiviano" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="$" />
              </div>
              <div>
                <label class="text-sm font-semibold">Pesado</label>
                <input id="pricePesado" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="$" />
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Card: Contenido y redes -->
      <section class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
        <h2 class="text-lg font-bold">3) Contenido y redes</h2>
        <p class="mt-1 text-sm text-slate-600">Para que el contenido venda y también construya marca.</p>

        <div class="mt-6 grid gap-4 sm:grid-cols-2">
          <div>
            <label class="text-sm font-semibold">Objetivo principal <span class="text-rose-600">*</span></label>
            <select id="goal" data-required="true" data-label="Objetivo principal"
              class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm">
              <option value="">Selecciona</option>
              <option>Ventas (WhatsApp / citas)</option>
              <option>Marca (confianza / reputación)</option>
              <option>Mixto (ventas + marca)</option>
            </select>
          </div>

          <div>
            <label class="text-sm font-semibold">CTA principal <span class="text-rose-600">*</span></label>
            <select id="cta" data-required="true" data-label="CTA principal"
              class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm">
              <option value="">Selecciona</option>
              <option>Agenda por WhatsApp</option>
              <option>Ven sin cita</option>
              <option>Ubicación</option>
              <option>Llama ahora</option>
            </select>
          </div>

          <div class="sm:col-span-2 rounded-2xl border border-slate-200 bg-slate-50 p-5">
            <div class="text-sm font-semibold">Redes activas</div>
            <div class="mt-3 grid gap-2 sm:grid-cols-6 text-sm">
              <label class="flex items-center gap-2"><input id="netIG" type="checkbox" class="h-4 w-4 rounded border-slate-300"> IG</label>
              <label class="flex items-center gap-2"><input id="netTT" type="checkbox" class="h-4 w-4 rounded border-slate-300"> TikTok</label>
              <label class="flex items-center gap-2"><input id="netFB" type="checkbox" class="h-4 w-4 rounded border-slate-300"> Facebook</label>
              <label class="flex items-center gap-2"><input id="netYT" type="checkbox" class="h-4 w-4 rounded border-slate-300"> YouTube</label>
              <label class="flex items-center gap-2"><input id="netGB" type="checkbox" class="h-4 w-4 rounded border-slate-300"> Google Business</label>
              <!-- NUEVO: LinkedIn -->
              <label class="flex items-center gap-2"><input id="netLI" type="checkbox" class="h-4 w-4 rounded border-slate-300"> LinkedIn</label>
            </div>
            <div class="mt-4 grid gap-3 sm:grid-cols-2">
              <div>
                <label class="text-sm font-semibold">Usuario / @ (principal)</label>
                <input id="handle" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="@usuario" />
              </div>
              <div>
                <label class="text-sm font-semibold">Link (principal)</label>
                <input id="socialLink" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="https://..." />
              </div>
            </div>
          </div>

          <div class="sm:col-span-2">
            <label class="text-sm font-semibold">Mensajes clave (mínimo 3) <span class="text-rose-600">*</span></label>
            <div id="msgWrap" class="mt-2 grid gap-2"></div>
            <button type="button" class="mt-3 rounded-xl bg-slate-900 px-3 py-2 text-sm font-semibold text-white hover:bg-black"
                    onclick="addRow('msgWrap','msg')">
              Agregar mensaje
            </button>
          </div>
        </div>
      </section>

      <!-- NUEVO: Card Prioridad de material (estáticos, carruseles, flyers) -->
      <section class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
        <h2 class="text-lg font-bold">3.1) Prioridad de material gráfico</h2>
        <p class="mt-1 text-sm text-slate-600">Para imágenes estáticas, carruseles y flyers: ¿qué tipo de material tiene más importancia?</p>

        <div class="mt-6 grid gap-4 sm:grid-cols-3">
          <!-- Estáticos -->
          <div class="rounded-2xl border border-slate-200 p-5">
            <div class="text-sm font-semibold">Imágenes estáticas <span class="text-rose-600">*</span></div>
            <div class="mt-3 grid gap-2 text-sm">
              <label class="flex items-center gap-2"><input type="radio" name="prioStatic" value="Educativo" class="h-4 w-4"> Educativo</label>
              <label class="flex items-center gap-2"><input type="radio" name="prioStatic" value="Corporativo" class="h-4 w-4"> Corporativo</label>
              <label class="flex items-center gap-2"><input type="radio" name="prioStatic" value="Servicios" class="h-4 w-4"> Servicios</label>
            </div>
          </div>

          <!-- Carruseles -->
          <div class="rounded-2xl border border-slate-200 p-5">
            <div class="text-sm font-semibold">Carruseles <span class="text-rose-600">*</span></div>
            <div class="mt-3 grid gap-2 text-sm">
              <label class="flex items-center gap-2"><input type="radio" name="prioCarousel" value="Educativo" class="h-4 w-4"> Educativo</label>
              <label class="flex items-center gap-2"><input type="radio" name="prioCarousel" value="Corporativo" class="h-4 w-4"> Corporativo</label>
              <label class="flex items-center gap-2"><input type="radio" name="prioCarousel" value="Servicios" class="h-4 w-4"> Servicios</label>
            </div>
          </div>

          <!-- Flyers -->
          <div class="rounded-2xl border border-slate-200 p-5">
            <div class="text-sm font-semibold">Flyers <span class="text-rose-600">*</span></div>
            <div class="mt-3 grid gap-2 text-sm">
              <label class="flex items-center gap-2"><input type="radio" name="prioFlyers" value="Educativo" class="h-4 w-4"> Educativo</label>
              <label class="flex items-center gap-2"><input type="radio" name="prioFlyers" value="Corporativo" class="h-4 w-4"> Corporativo</label>
              <label class="flex items-center gap-2"><input type="radio" name="prioFlyers" value="Servicios" class="h-4 w-4"> Servicios</label>
            </div>
          </div>

          <div class="sm:col-span-3 rounded-2xl border border-slate-200 bg-slate-50 p-5">
            <label class="text-sm font-semibold">Notas (opcional)</label>
            <textarea id="prioNotes" class="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" rows="3"
                      placeholder="Ej: estáticos para horarios y promos, carruseles educativos para mitos del RTM, flyers para campañas..."></textarea>
          </div>
        </div>
      </section>

      <!-- Card: Voceros y permisos -->
      <section class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
        <h2 class="text-lg font-bold">4) Voceros y permisos de grabación</h2>
        <p class="mt-1 text-sm text-slate-600">Quién puede salir en cámara y condiciones para grabar sin fricciones.</p>

        <div class="mt-6 grid gap-6">
          <div class="rounded-2xl border border-slate-200 p-5">
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
              <div>
                <div class="text-sm font-semibold">Personas autorizadas para salir en cámara <span class="text-rose-600">*</span></div>
                <p class="text-sm text-slate-600">Mínimo 1 persona. Incluye rol y tema que domina.</p>
              </div>
              <button type="button" class="rounded-xl bg-slate-100 px-3 py-2 text-sm font-semibold hover:bg-slate-200"
                      onclick="addPerson()">
                Agregar persona
              </button>
            </div>
            <div id="peopleWrap" class="mt-4 grid gap-4"></div>
          </div>

          <div class="grid gap-4 sm:grid-cols-2">
            <div>
              <label class="text-sm font-semibold">Zonas permitidas para grabar <span class="text-rose-600">*</span></label>
              <textarea id="zonesAllowed" data-required="true" data-label="Zonas permitidas"
                class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" rows="4"
                placeholder="Ej: recepción, sala de espera, línea livianos, fachada..."></textarea>
            </div>
            <div>
              <label class="text-sm font-semibold">Zonas NO permitidas <span class="text-rose-600">*</span></label>
              <textarea id="zonesNo" data-required="true" data-label="Zonas no permitidas"
                class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" rows="4"
                placeholder="Ej: área de documentos, placa visible, zonas internas..."></textarea>
            </div>
          </div>

          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-5">
            <div class="text-sm font-semibold">Palabras obligatorias y prohibidas (en contenido)</div>
            <div class="mt-4 grid gap-4 sm:grid-cols-2">
              <div>
                <label class="text-sm font-semibold">Palabras que SÍ deben aparecer <span class="text-rose-600">*</span></label>
                <input id="mustWords" data-required="true" data-label="Palabras obligatorias"
                  class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm"
                  placeholder="Ej: transparencia, diagnóstico, confianza" />
              </div>
              <div>
                <label class="text-sm font-semibold">Palabras que NO deben aparecer <span class="text-rose-600">*</span></label>
                <input id="noWords" data-required="true" data-label="Palabras prohibidas"
                  class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm"
                  placeholder="Ej: garantizado, pasa seguro, aprobado fijo" />
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Actions -->
      <section class="rounded-3xl border border-slate-200 bg-white p-5 shadow-sm">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <div class="text-sm font-semibold">Finalizar</div>
            <p class="mt-1 text-sm text-slate-600">Genera el resumen y luego el PDF (descargar o imprimir/guardar).</p>
          </div>
          <div class="flex flex-wrap gap-3">
            <button type="button" class="rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-black"
                    onclick="goToSummary()">
              Ver resumen
            </button>
          </div>
        </div>
      </section>
    </section>

    <!-- SUMMARY VIEW (ON SCREEN + PRINT AREA) -->
    <section id="summaryView" class="hidden">
      <!-- Botones (solo 2) -->
      <div class="no-print mb-4 flex flex-wrap items-center justify-between gap-3">
        <button type="button" class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold hover:bg-slate-50"
                onclick="backToForm()">
          Volver a editar
        </button>

        <div class="flex flex-wrap gap-3">
          <button type="button" class="rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700"
                  onclick="downloadPDF()">
            Descargar PDF
          </button>
          <button type="button" class="rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-black"
                  onclick="printPDF()">
            Imprimir / Guardar PDF
          </button>
        </div>
      </div>

      <!-- Este es el contenido que se imprime / exporta -->
      <section id="printArea" class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm"></section>
    </section>
  </main>

  <script>
    /***************
     * Draft local
     ***************/
    const STORAGE_KEY = "coldron_cda_brief_v1";
    const setStatus = (t) => (document.getElementById("saveStatus").textContent = t);

    function saveDraft() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(collectData()));
        setStatus("guardado");
      } catch (e) {
        setStatus("sin guardar");
      }
    }

    function loadDraft() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const d = JSON.parse(raw);
        if (!d || typeof d !== "object") return;

        const map = (id, val) => { const el = document.getElementById(id); if (el && val != null) el.value = val; };
        map("cdaName", d.cdaName);
        map("legalName", d.legalName);
        map("nit", d.nit);
        map("whatsapp", d.whatsapp);
        map("address", d.address);
        map("maps", d.maps);
        map("hours", d.hours);
        map("avgTime", d.avgTime);
        map("waLink", d.waLink);
        map("priceMoto", d.prices?.moto);
        map("priceLiviano", d.prices?.liviano);
        map("pricePesado", d.prices?.pesado);
        map("handle", d.handle);
        map("socialLink", d.socialLink);
        map("zonesAllowed", d.zonesAllowed);
        map("zonesNo", d.zonesNo);
        map("mustWords", d.mustWords);
        map("noWords", d.noWords);

        // NUEVO: notas prioridades
        map("prioNotes", d.priorities?.notes);

        setCheck("lineMotos", d.lines?.motos);
        setCheck("lineLivianos", d.lines?.livianos);
        setCheck("linePesados", d.lines?.pesados);
        setCheck("lineMixto", d.lines?.mixto);

        if (d.mode) {
          document.querySelectorAll('input[name="mode"]').forEach(r => r.checked = (r.value === d.mode));
        }

        setCheck("netIG", d.networks?.ig);
        setCheck("netTT", d.networks?.tt);
        setCheck("netFB", d.networks?.fb);
        setCheck("netYT", d.networks?.yt);
        setCheck("netGB", d.networks?.gb);
        // NUEVO: LinkedIn
        setCheck("netLI", d.networks?.li);

        setSelect("goal", d.goal);
        setSelect("cta", d.cta);

        // NUEVO: radios de prioridades
        setRadio("prioStatic", d.priorities?.static);
        setRadio("prioCarousel", d.priorities?.carousel);
        setRadio("prioFlyers", d.priorities?.flyers);

        rebuildRows("servicesWrap", "service", d.services || ["RTM"]);
        rebuildRows("diffWrap", "diff", d.differentials || ["Rapidez", "Transparencia", "Ubicación"]);
        rebuildRows("msgWrap", "msg", d.messages || ["Atención clara y transparente", "Agenda fácil por WhatsApp", "Proceso explicado sin enredos"]);

        rebuildPeople(d.people || [{
          name: "",
          role: "Director técnico",
          topic: "",
          availability: "Mañana",
          authorized: false
        }]);

        setStatus("recuperado");
      } catch (e) {}
    }

    function resetDraft() {
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }

    function setCheck(id, v) {
      const el = document.getElementById(id);
      if (el) el.checked = !!v;
    }
    function setSelect(id, v) {
      const el = document.getElementById(id);
      if (el && v != null) el.value = v;
    }
    function setRadio(name, value) {
      if (!value) return;
      document.querySelectorAll(`input[name="${name}"]`).forEach(r => r.checked = (r.value === value));
    }

    function addRow(wrapId, prefix, value = "") {
      const wrap = document.getElementById(wrapId);
      const idx = wrap.querySelectorAll("input").length;
      const row = document.createElement("div");
      row.className = "flex gap-2";
      row.innerHTML = `
        <input id="${prefix}_${idx}" class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm"
               placeholder="Escribe aquí..." value="${escapeHtml(value)}" />
        <button type="button" class="rounded-xl bg-slate-100 px-3 py-2 text-sm font-semibold hover:bg-slate-200" title="Eliminar">✕</button>
      `;
      row.querySelector("button").onclick = () => { row.remove(); saveDraft(); };
      row.querySelector("input").addEventListener("input", saveDraftDebounced);
      wrap.appendChild(row);
      saveDraft();
    }

    function rebuildRows(wrapId, prefix, values) {
      const wrap = document.getElementById(wrapId);
      wrap.innerHTML = "";
      (values || []).forEach(v => addRow(wrapId, prefix, v));
    }

    function addPerson(person = null) {
      const wrap = document.getElementById("peopleWrap");
      const idx = wrap.querySelectorAll("[data-person]").length;

      const p = person || { name:"", role:"Director técnico", topic:"", availability:"Mañana", authorized:false };
      const card = document.createElement("div");
      card.className = "rounded-2xl border border-slate-200 bg-white p-4";
      card.setAttribute("data-person", "1");

      card.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div class="text-sm font-semibold">Persona ${idx + 1}</div>
          <button type="button" class="rounded-xl bg-slate-100 px-3 py-2 text-sm font-semibold hover:bg-slate-200">Eliminar</button>
        </div>

        <div class="mt-4 grid gap-3 sm:grid-cols-2">
          <div>
            <label class="text-sm font-semibold">Nombre completo <span class="text-rose-600">*</span></label>
            <input data-p="name" data-required="true" data-label="Nombre de persona autorizada"
              class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" value="${escapeHtml(p.name)}" />
          </div>
          <div>
            <label class="text-sm font-semibold">Rol / cargo <span class="text-rose-600">*</span></label>
            <select data-p="role" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm">
              ${["Gerente","Director técnico","Inspector","Asesor comercial","Servicio al cliente","Otro"].map(opt =>
                `<option ${p.role===opt?"selected":""}>${opt}</option>`
              ).join("")}
            </select>
          </div>

          <div class="sm:col-span-2">
            <label class="text-sm font-semibold">Tema que puede explicar en 30 segundos <span class="text-rose-600">*</span></label>
            <textarea data-p="topic" data-required="true" data-label="Tema que explica la persona"
              class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" rows="3"
              placeholder="Ej: qué revisar antes de venir, por qué fallan frenos, mitos del RTM...">${escapeHtml(p.topic)}</textarea>
          </div>

          <div>
            <label class="text-sm font-semibold">Disponibilidad</label>
            <select data-p="availability" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm">
              ${["Mañana","Tarde","Día completo"].map(opt =>
                `<option ${p.availability===opt?"selected":""}>${opt}</option>`
              ).join("")}
            </select>
          </div>

          <div class="flex items-start gap-3 pt-1">
            <input data-p="authorized" type="checkbox" class="mt-1 h-4 w-4 rounded border-slate-300" ${p.authorized?"checked":""} />
            <div>
              <div class="text-sm font-semibold">Autorización de imagen <span class="text-rose-600">*</span></div>
              <div class="text-xs text-slate-600">Confirmación para aparecer en cámara y uso en redes.</div>
            </div>
          </div>
        </div>
      `;

      card.querySelector("button").onclick = () => { card.remove(); saveDraft(); };
      card.querySelectorAll("input, select, textarea").forEach(el => {
        el.addEventListener("input", saveDraftDebounced);
        el.addEventListener("change", saveDraftDebounced);
      });

      wrap.appendChild(card);
      saveDraft();
    }

    function rebuildPeople(people) {
      const wrap = document.getElementById("peopleWrap");
      wrap.innerHTML = "";
      (people || []).forEach(p => addPerson(p));
    }

    function hideAlert() {
      document.getElementById("alertBox").classList.add("hidden");
      document.getElementById("missingList").innerHTML = "";
    }

    function showAlert(items) {
      const box = document.getElementById("alertBox");
      const list = document.getElementById("missingList");
      list.innerHTML = "";
      items.forEach(t => {
        const li = document.createElement("li");
        li.textContent = t;
        list.appendChild(li);
      });
      box.classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function validateForm() {
      const missing = [];

      document.querySelectorAll("#formView [data-required='true']").forEach(el => {
        const label = el.getAttribute("data-label") || "Campo obligatorio";
        const val = (el.value || "").trim();
        if (!val) missing.push(label);
      });

      const anyLine = ["lineMotos","lineLivianos","linePesados","lineMixto"].some(id => document.getElementById(id).checked);
      if (!anyLine) missing.push("Tipo de línea (selecciona al menos una opción)");

      const mode = getRadio("mode");
      if (!mode) missing.push("Modalidad de atención");

      const services = getListValues("servicesWrap");
      if (services.length < 1) missing.push("Servicios ofrecidos (mínimo 1)");

      const diffs = getListValues("diffWrap");
      if (diffs.length < 3) missing.push("Diferenciales (mínimo 3)");

      const msgs = getListValues("msgWrap");
      if (msgs.length < 3) missing.push("Mensajes clave (mínimo 3)");

      // NUEVO: prioridades material
      if (!getRadio("prioStatic")) missing.push("Prioridad: Imágenes estáticas (educativo/corporativo/servicios)");
      if (!getRadio("prioCarousel")) missing.push("Prioridad: Carruseles (educativo/corporativo/servicios)");
      if (!getRadio("prioFlyers")) missing.push("Prioridad: Flyers (educativo/corporativo/servicios)");

      const people = collectPeople();
      if (people.length < 1) missing.push("Personas autorizadas (mínimo 1)");

      people.forEach((p, i) => {
        if (!p.name) missing.push(`Persona ${i+1}: nombre`);
        if (!p.role) missing.push(`Persona ${i+1}: rol`);
        if (!p.topic) missing.push(`Persona ${i+1}: tema`);
        if (!p.authorized) missing.push(`Persona ${i+1}: autorización de imagen`);
      });

      if (missing.length) {
        showAlert(missing);
        return false;
      }
      hideAlert();
      return true;
    }

    function getRadio(name) {
      const el = document.querySelector(`input[name="${name}"]:checked`);
      return el ? el.value : "";
    }

    function getListValues(wrapId) {
      return Array.from(document.getElementById(wrapId).querySelectorAll("input"))
        .map(i => (i.value || "").trim())
        .filter(Boolean);
    }

    function collectPeople() {
      return Array.from(document.querySelectorAll("#peopleWrap [data-person]")).map(card => {
        const get = (key) => {
          const el = card.querySelector(`[data-p="${key}"]`);
          if (!el) return "";
          if (el.type === "checkbox") return el.checked;
          return (el.value || "").trim();
        };
        return {
          name: get("name"),
          role: get("role"),
          topic: get("topic"),
          availability: get("availability"),
          authorized: !!get("authorized")
        };
      });
    }

    function collectData() {
      const d = {
        cdaName: val("cdaName"),
        legalName: val("legalName"),
        nit: val("nit"),
        whatsapp: val("whatsapp"),
        address: val("address"),
        maps: val("maps"),
        hours: val("hours"),

        lines: {
          motos: chk("lineMotos"),
          livianos: chk("lineLivianos"),
          pesados: chk("linePesados"),
          mixto: chk("lineMixto"),
        },

        mode: getRadio("mode"),
        avgTime: val("avgTime"),
        waLink: val("waLink"),

        differentials: getListValues("diffWrap"),
        services: getListValues("servicesWrap"),

        prices: {
          moto: val("priceMoto"),
          liviano: val("priceLiviano"),
          pesado: val("pricePesado"),
        },

        goal: val("goal"),
        cta: val("cta"),

        networks: {
          ig: chk("netIG"),
          tt: chk("netTT"),
          fb: chk("netFB"),
          yt: chk("netYT"),
          gb: chk("netGB"),
          // NUEVO: LinkedIn
          li: chk("netLI"),
        },
        handle: val("handle"),
        socialLink: val("socialLink"),

        messages: getListValues("msgWrap"),

        // NUEVO: prioridades material
        priorities: {
          static: getRadio("prioStatic"),
          carousel: getRadio("prioCarousel"),
          flyers: getRadio("prioFlyers"),
          notes: val("prioNotes"),
        },

        people: collectPeople(),

        zonesAllowed: val("zonesAllowed"),
        zonesNo: val("zonesNo"),
        mustWords: val("mustWords"),
        noWords: val("noWords"),

        generatedAt: new Date().toISOString(),
      };
      return d;
    }

    function val(id) {
      const el = document.getElementById(id);
      return el ? (el.value || "").trim() : "";
    }
    function chk(id) {
      const el = document.getElementById(id);
      return el ? !!el.checked : false;
    }

    function goToSummary() {
      if (!validateForm()) return;

      const d = collectData();
      saveDraft();

      const area = document.getElementById("printArea");
      area.innerHTML = buildSummaryHTML(d);

      document.getElementById("formView").classList.add("hidden");
      document.getElementById("summaryView").classList.remove("hidden");

      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function backToForm() {
      document.getElementById("summaryView").classList.add("hidden");
      document.getElementById("formView").classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function buildSummaryHTML(d) {
      const esc = escapeHtml;

      const lineLabels = [];
      if (d.lines.motos) lineLabels.push("Motos");
      if (d.lines.livianos) lineLabels.push("Livianos");
      if (d.lines.pesados) lineLabels.push("Pesados");
      if (d.lines.mixto) lineLabels.push("Mixto");

      const nets = [];
      if (d.networks.ig) nets.push("Instagram");
      if (d.networks.tt) nets.push("TikTok");
      if (d.networks.fb) nets.push("Facebook");
      if (d.networks.yt) nets.push("YouTube");
      if (d.networks.gb) nets.push("Google Business");
      // NUEVO: LinkedIn
      if (d.networks.li) nets.push("LinkedIn");

      const list = (arr) => (arr && arr.length)
        ? `<ul class="mt-2 list-disc pl-5 text-sm">${arr.map(x => `<li>${esc(x)}</li>`).join("")}</ul>`
        : `<div class="mt-2 text-sm text-slate-500">No registrado</div>`;

      const peopleRows = (d.people || []).map(p => `
        <tr>
          <td class="border-b border-slate-200 py-2 pr-3">${esc(p.name)}</td>
          <td class="border-b border-slate-200 py-2 pr-3">${esc(p.role)}</td>
          <td class="border-b border-slate-200 py-2 pr-3">${esc(p.availability || "")}</td>
          <td class="border-b border-slate-200 py-2 pr-3">${esc(p.topic)}</td>
          <td class="border-b border-slate-200 py-2 pr-3">${p.authorized ? "Sí" : "No"}</td>
        </tr>
      `).join("");

      const date = new Date().toLocaleString("es-CO", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });

      return `
        <div style="font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, 'Noto Sans', 'Liberation Sans', sans-serif;">
          <div class="avoid-break">
            <div class="flex items-start justify-between gap-4">
              <div class="flex items-start gap-3">
                <img
                  src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ-jAnp9C1mhpW1RVtR_MGWwnQLJGGf9Qg0Uw&s"
                  alt="Coldron Colombia"
                  style="height:34px;width:auto;"
                  referrerpolicy="no-referrer"
                  crossorigin="anonymous"
                  onerror="this.style.display='none'"
                >
                <div>
                  <h1 class="text-2xl font-bold">Coldron Colombia</h1>
                  <div class="text-sm text-slate-600">Reporte resumen</div>
                </div>
              </div>
              <div class="text-right text-sm">
                <div class="font-semibold">Generado</div>
                <div class="text-slate-700">${esc(date)}</div>
              </div>
            </div>

            <div class="mt-4 rounded-2xl border border-slate-200 p-4">
              <div class="grid gap-3 sm:grid-cols-3 text-sm">
                <div>
                  <div class="text-xs font-semibold text-slate-600">CDA</div>
                  <div class="text-sm font-semibold">${esc(d.cdaName)}</div>
                  <div class="text-xs text-slate-600">${esc(d.legalName)} | NIT: ${esc(d.nit)}</div>
                </div>
                <div>
                  <div class="text-xs font-semibold text-slate-600">Ubicación</div>
                  <div class="text-sm">${esc(d.address)}</div>
                  <div class="text-xs text-slate-600">${d.maps ? esc(d.maps) : "Maps no registrado"}</div>
                </div>
                <div>
                  <div class="text-xs font-semibold text-slate-600">Contacto</div>
                  <div class="text-sm">WhatsApp: ${esc(d.whatsapp)}</div>
                  <div class="text-xs text-slate-600">Horario: ${esc(d.hours)}</div>
                </div>
              </div>
            </div>
          </div>

          <div class="page-break"></div>

          <div class="avoid-break">
            <h2 class="text-lg font-bold">1. Operación y ventas</h2>
            <div class="mt-3 rounded-2xl border border-slate-200 p-4 text-sm">
              <div class="grid gap-3 sm:grid-cols-3">
                <div><span class="text-xs font-semibold text-slate-600 block">Tipo de línea</span>${esc(lineLabels.join(", "))}</div>
                <div><span class="text-xs font-semibold text-slate-600 block">Modalidad</span>${esc(d.mode)}</div>
                <div><span class="text-xs font-semibold text-slate-600 block">Tiempo promedio</span>${esc(d.avgTime)}</div>
                <div class="sm:col-span-3"><span class="text-xs font-semibold text-slate-600 block">WhatsApp (agenda)</span>${d.waLink ? esc(d.waLink) : "No registrado"}</div>
              </div>
            </div>

            <div class="mt-4 rounded-2xl border border-slate-200 p-4">
              <div class="text-sm font-semibold">Diferenciales</div>
              ${list(d.differentials)}
            </div>

            <div class="mt-4 rounded-2xl border border-slate-200 p-4">
              <div class="text-sm font-semibold">Servicios</div>
              ${list(d.services)}
            </div>

            <div class="mt-4 rounded-2xl border border-slate-200 p-4">
              <div class="text-sm font-semibold">Precios (si aplican)</div>
              <div class="mt-2 grid gap-2 sm:grid-cols-3 text-sm">
                <div><span class="text-xs font-semibold text-slate-600 block">Moto</span>${esc(d.prices.moto || "No registrado")}</div>
                <div><span class="text-xs font-semibold text-slate-600 block">Liviano</span>${esc(d.prices.liviano || "No registrado")}</div>
                <div><span class="text-xs font-semibold text-slate-600 block">Pesado</span>${esc(d.prices.pesado || "No registrado")}</div>
              </div>
            </div>
          </div>

          <div class="page-break"></div>

          <div class="avoid-break">
            <h2 class="text-lg font-bold">2. Contenido y redes</h2>
            <div class="mt-3 rounded-2xl border border-slate-200 p-4 text-sm">
              <div class="grid gap-3 sm:grid-cols-2">
                <div><span class="text-xs font-semibold text-slate-600 block">Objetivo</span>${esc(d.goal)}</div>
                <div><span class="text-xs font-semibold text-slate-600 block">CTA principal</span>${esc(d.cta)}</div>
                <div class="sm:col-span-2"><span class="text-xs font-semibold text-slate-600 block">Redes activas</span>${esc(nets.join(", ") || "No registrado")}</div>
                <div><span class="text-xs font-semibold text-slate-600 block">Usuario/@</span>${esc(d.handle || "No registrado")}</div>
                <div><span class="text-xs font-semibold text-slate-600 block">Link</span>${esc(d.socialLink || "No registrado")}</div>
              </div>
            </div>

            <div class="mt-4 rounded-2xl border border-slate-200 p-4">
              <div class="text-sm font-semibold">Mensajes clave</div>
              ${list(d.messages)}
            </div>

            <div class="mt-4 rounded-2xl border border-slate-200 bg-slate-50 p-4">
              <div class="text-sm font-semibold">Prioridad de material gráfico</div>
              <div class="mt-3 grid gap-3 sm:grid-cols-3 text-sm">
                <div><span class="text-xs font-semibold text-slate-600 block">Imágenes estáticas</span>${esc(d.priorities?.static || "No registrado")}</div>
                <div><span class="text-xs font-semibold text-slate-600 block">Carruseles</span>${esc(d.priorities?.carousel || "No registrado")}</div>
                <div><span class="text-xs font-semibold text-slate-600 block">Flyers</span>${esc(d.priorities?.flyers || "No registrado")}</div>
                <div class="sm:col-span-3"><span class="text-xs font-semibold text-slate-600 block">Notas</span>${d.priorities?.notes ? esc(d.priorities.notes) : "No registrado"}</div>
              </div>
            </div>
          </div>

          <div class="page-break"></div>

          <div class="avoid-break">
            <h2 class="text-lg font-bold">3. Voceros y permisos</h2>

            <div class="mt-3 rounded-2xl border border-slate-200 p-4">
              <div class="text-sm font-semibold">Personas autorizadas para salir en cámara</div>
              <div class="mt-3 overflow-x-auto">
                <table class="w-full min-w-[820px] border-collapse text-sm">
                  <thead>
                    <tr class="text-left">
                      <th class="border-b border-slate-200 py-2 pr-3">Nombre</th>
                      <th class="border-b border-slate-200 py-2 pr-3">Rol</th>
                      <th class="border-b border-slate-200 py-2 pr-3">Disponibilidad</th>
                      <th class="border-b border-slate-200 py-2 pr-3">Tema</th>
                      <th class="border-b border-slate-200 py-2 pr-3">Autorizado</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${peopleRows || `<tr><td colspan="5" class="py-3 text-slate-500">No registrado</td></tr>`}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="mt-4 grid gap-4 sm:grid-cols-2">
              <div class="rounded-2xl border border-slate-200 p-4">
                <div class="text-sm font-semibold">Zonas permitidas</div>
                <div class="mt-2 text-sm">${esc(d.zonesAllowed)}</div>
              </div>
              <div class="rounded-2xl border border-slate-200 p-4">
                <div class="text-sm font-semibold">Zonas no permitidas</div>
                <div class="mt-2 text-sm">${esc(d.zonesNo)}</div>
              </div>
            </div>

            <div class="mt-4 rounded-2xl border border-slate-200 bg-slate-50 p-4">
              <div class="text-sm font-semibold">Lenguaje del contenido</div>
              <div class="mt-3 grid gap-3 sm:grid-cols-2 text-sm">
                <div><span class="text-xs font-semibold text-slate-600 block">Debe aparecer</span>${esc(d.mustWords)}</div>
                <div><span class="text-xs font-semibold text-slate-600 block">No debe aparecer</span>${esc(d.noWords)}</div>
              </div>
            </div>

            <div class="mt-6 text-xs text-slate-500">
              Documento generado para operación de contenidos por Coldron Colombia.
            </div>
          </div>
        </div>
      `;
    }

    async function waitForAssets() {
      if (document.fonts?.ready) await document.fonts.ready;
      const area = document.getElementById("printArea");
      const imgs = Array.from(area.querySelectorAll("img"));
      await Promise.all(imgs.map(img => {
        if (img.complete) return Promise.resolve();
        return new Promise(res => { img.onload = res; img.onerror = res; });
      }));
    }

    async function printPDF() {
      await waitForAssets();
      await new Promise(r => setTimeout(r, 120));
      window.print();
    }

    async function downloadPDF() {
      await waitForAssets();
      await new Promise(r => setTimeout(r, 120));

      const el = document.getElementById("printArea");
      const fname = `brief-coldron-${new Date().toISOString().slice(0,10)}.pdf`;

      const opt = {
        margin: 10,
        filename: fname,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
        pagebreak: { mode: ["css", "legacy"] }
      };

      try {
        await html2pdf().set(opt).from(el).save();
      } catch (e) {
        window.print();
      }
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    let saveTimer = null;
    function saveDraftDebounced() {
      clearTimeout(saveTimer);
      setStatus("guardando…");
      saveTimer = setTimeout(() => saveDraft(), 250);
    }

    function seedDefaults() {
      if (!document.querySelector("#diffWrap input")) {
        ["Rapidez","Transparencia","Ubicación"].forEach(v => addRow("diffWrap","diff",v));
      }
      if (!document.querySelector("#servicesWrap input")) {
        ["RTM"].forEach(v => addRow("servicesWrap","service",v));
      }
      if (!document.querySelector("#msgWrap input")) {
        ["Atención clara y transparente","Agenda fácil por WhatsApp","Proceso explicado sin enredos"].forEach(v => addRow("msgWrap","msg",v));
      }
      if (!document.querySelector("#peopleWrap [data-person]")) {
        addPerson();
      }
    }

    document.addEventListener("input", (e) => {
      if (!e.target.closest("#formView")) return;
      saveDraftDebounced();
    });
    document.addEventListener("change", (e) => {
      if (!e.target.closest("#formView")) return;
      saveDraftDebounced();
    });

    loadDraft();
    seedDefaults();
    setStatus("listo");
  </script>
</body>
</html>
